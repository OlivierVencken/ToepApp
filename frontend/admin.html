<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Toepen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="/static/css/custom.css" rel="stylesheet" />
</head>

<body class="p-4 max-w-lg mx-auto bg-gray-100 min-h-screen">
  <div class="text-right mb-2">
    <a href="/logout" class="text-sm text-blue-600">uitloggen</a>
  </div>
  <h1 class="text-3xl font-bold mb-6 text-center text-red-600">Admin Panel</h1>

  <!-- Header row -->
  <div class="grid grid-cols-4 gap-2 font-semibold border-b pb-2 mb-2">
    <div>Speler</div>
    <div class="text-center">Wins</div>
    <div class="text-center">Losses</div>
    <div class="text-center">Actions</div>
  </div>

  <!-- Player rows -->
  <ul id="adminList" class="space-y-2"></ul>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBizOIJGSS6OSUm1P0CbrYlNVWOzna6e_Y",
      authDomain: "toepapp-9f46c.firebaseapp.com",
      databaseURL: "https://toepapp-9f46c-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "toepapp-9f46c",
      storageBucket: "toepapp-9f46c.firebasestorage.app",
      messagingSenderId: "1028290422568",
      appId: "1:1028290422568:web:5ded1f7b8b3f39ae76121d",
      measurementId: "G-RDTJFC4QSL"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Push a record (win/loss delta) for a player
    function pushRecord(name, winDelta, lossDelta) {
      return db.ref('leaderboard').push({
        name,
        wins: winDelta,
        losses: lossDelta,
        ts: Date.now()
      });
    }

    // Remove all records for a player
    async function removePlayer(name) {
      const ref = db.ref('leaderboard');
      const snap = await ref.orderByChild('name').equalTo(name).once('value');
      const updates = {};
      snap.forEach(child => {
        updates[child.key] = null;
      });
      // Batch remove
      return ref.update(updates);
    }

    // Fetch and aggregate all stats from /leaderboard
    async function fetchAllPlayers() {
      const snap = await db.ref('leaderboard').once('value');
      const entries = snap.val() || {};
      const agg = {};
      Object.values(entries).forEach(r => {
        if (!agg[r.name]) agg[r.name] = { name: r.name, wins: 0, losses: 0 };
        agg[r.name].wins += r.wins;
        agg[r.name].losses += r.losses;
      });
      return Object.values(agg).sort((a, b) => b.wins - a.wins);
    }

    // Render admin list
    async function renderAdmin() {
      const players = await fetchAllPlayers();
      const ul = document.getElementById('adminList');
      ul.innerHTML = players.map(p => `
        <li class="bg-white p-4 rounded shadow grid grid-cols-4 items-center">
          <div>${p.name}</div>
          <div class="text-center">${p.wins}</div>
          <div class="text-center">${p.losses}</div>
          <div class="text-center space-y-1">
            <div class="space-x-1">
              <button data-name="${p.name}" data-action="addWin"  class="btn btn-success p-1">+Win</button>
              <button data-name="${p.name}" data-action="remWin"  class="btn btn-secondary p-1">–Win</button>
              <button data-name="${p.name}" data-action="addLoss" class="btn btn-danger p-1">+Loss</button>
              <button data-name="${p.name}" data-action="remLoss" class="btn btn-secondary p-1">–Loss</button>
            </div>
            <div>
              <button data-name="${p.name}" data-action="removePlayer" class="btn btn-danger p-1 w-full">remove player</button>
            </div>
          </div>
        </li>
      `).join('');
    }

    // Handle button actions
    document.body.addEventListener('click', async e => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const name = btn.dataset.name;
      const action = btn.dataset.action;
      let w = 0, l = 0;
      if (action === 'addWin') w = 1;
      if (action === 'remWin') w = -1;
      if (action === 'addLoss') l = 1;
      if (action === 'remLoss') l = -1;
      if (action === 'removePlayer') {
        await removePlayer(name);
        return renderAdmin();
      }
      await pushRecord(name, w, l);
      renderAdmin();
    });

    // Initial load
    renderAdmin();
  </script>
</body>

</html>